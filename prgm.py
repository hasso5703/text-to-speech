texte = [
"""
*carrot* n. A1 
I peeled carrots for the salad.
J'ai épluché des carottes pour la salade.
""",
"""
*carry* v. A1 
The train that was carrying the goods left yesterday.
Le train qui transportait les marchandises est parti hier.
Donkeys can carry very heavy burdens.
Les ânes peuvent transporter des fardeaux très lourds.
The father carries his daughter on his shoulders.
Le père porte sa fille sur ses épaules.
The soldier carried a rifle.
Le soldat portait un fusil.
""",
"""
*cartoon* n. A2 
My children love watching cartoons.
Mes enfants aiment regarder les dessins animés.
""",
"""
*case* n. A2 
An umbrella is convenient in case of rain.
Un parapluie est utile en cas de pluie.
I will take an umbrella, just in case.
Je vais prendre un parapluie, au cas où.
The judge declared the case closed.
Le juge a déclaré l'affaire classée.
The testimony of the witness decided the case.
La preuve du témoin a tranché l'affaire.
My watch has a flat case and a leather strap.
Ma montre a un boîtier plat et un bracelet en cuir.
My phone's case is made of real leather.
L'étui de mon téléphone est en cuir véritable.
The phone fits perfectly into the case.
Le téléphone tient parfaitement dans l'étui.
""",
"""
*cash* n. A2 
The supermarket only accepts cash.
Le supermarché n'accepte que les espèces.
Customers can pay in cash or by debit card.
Les clients peuvent payer en espèces ou par carte de débit.
I did not have any cash, so I paid by credit card.
Je n'avais pas de cash, alors j'ai payé par carte de crédit.
The cash he received for his invention is a windfall.
L'argent qu'il a reçu pour son invention est une aubaine.
The cash value of my car remained stable.
La valeur monétaire de ma voiture est restée stable.
The bank agreed to cash his cheque.
La banque a accepté d'encaisser son chèque.
""",
"""
*cast* n., v. B2 
The statue was cast in bronze.
La statue a été moulée en bronze.
I made a cast of the footprint to preserve it.
J'ai fait un moulage de l'empreinte pour la conserver.
Two famous actors are part of the play's cast.
Deux acteurs connus font partie de la distribution de la pièce.
My friends signed the cast on my arm.
Mes amis ont signé le plâtre sur mon bras.
The witch cast a spell on him.
La sorcière lui a jeté un sort.
The boats can cast anchor in the harbour.
Les bateaux peuvent jeter l'ancre dans le port.
The witch cast a spell on him.
La sorcière lui a lancé un sort.
The fisherman baited his hook and cast his line.
Le pêcheur a appâté son hameçon et lancé sa ligne.
The worker casts molten metal into the form.
L'ouvrier coule du métal en fusion dans le moule.
The statue was cast in bronze.
La statue a été moulée en bronze.
""",
"""
*cat* n. A1 
We have always had a cat as a pet.
Nous avons toujours eu un chat comme animal de compagnie.
The cat chased the mouse.
Le chat a poursuivi la souris.
Our cat had a litter of four kittens.
Notre chatte a eu une portée de quatre chatons.
""",
"""
*catch* v. A2, n. B2 
One player throws the ball and the other player catches it.
Un joueur lance la balle et l'autre joueur l'attrape.
The police caught the thief.
La police a attrapé le voleur.
My dad likes to brag when he catches a big fish.
Mon papa aime se vanter quand il attrape un gros poisson.
They caught the last train.
Il ont pris le dernier train.
The camera caught images of the suspect at the scene of the crime.
La caméra a capté des images du suspect sur le lieu de crime.
The police officer caught the robber by the collar.
Le policier a saisi le cambrioleur par le col.
The police caught the thief after a quick investigation.
La police a arrêté le voleur après une enquête rapide.
The police caught the thief in the restaurant.
La police a coincé le voleur dans le restaurant.
The fisherman is proud of his catch.
Le pêcheur est fier de sa prise.
""",
"""
*category* n. B1 
Products are classified by category on our website.
Les produits sont classés par catégorie sur notre site web.
The budget is divided into categories of expenses.
Le budget est divisé en rubriques de dépenses.
""",
"""
*cause* n., v. A2 
I signed a petition to defend a good cause.
J'ai signé une pétition pour défendre une bonne cause.
The donations were used for charitable causes.
Les dons ont été utilisés pour des causes de bienfaisance.
All is well, there is no cause for concern.
Tout va bien, il n'y a pas de motif d'inquiétude.
Too little sleep can be a cause for stress.
Le manque de sommeil peut être un facteur de stress.
The heavy rainfall caused a flood.
Les grosses précipitations ont causé une inondation.
The political crisis caused turmoil in the country.
La crise politique a provoqué la tourmente dans le pays.
The storm caused a power outage.
La tempête a provoqué une panne d'électricité.
The drop in price caused an increase in sales.
La baisse du prix a entraîné une augmentation des ventes.
The rain caused a sudden drop in temperature.
La pluie a entraîné une chute brutale de la température.
The rain caused a traffic jam this morning.
La pluie a occasionné un bouchon ce matin.
The president's speech caused a series of protests.
Le discours du président a suscité une série de protestations.
""",
"""
*CD* n. A1 
I always listen to a CD when I drive.
J'écoute toujours un CD quand je conduis.
The CD of the band's latest album has ten tracks.
Le CD du dernier album du groupe contient dix pistes.
""",
"""
*ceiling* n. B1 
The chandelier hangs from the ceiling.
Le lustre pend du plafond.
The middle pillar supports the ceiling.
Le pilier central supporte le plafond.
""",
"""
*celebrate* v. A2 
The Assumption is celebrated on August 15.
L'Assomption est célébrée le 15 août.
My university celebrated its hundredth anniversary.
Mon université a célébré son centième anniversaire.
People generally celebrate their birthday.
En général, les gens fêtent leur anniversaire.
I will throw a party to celebrate my return home.
J'organiserai une fête pour célébrer mon retour à la maison.
After the match, the coach celebrated with the team.
Après le match, le coach a fait la fête avec l'équipe.
The city celebrated the anniversary of its founding.
La ville a commémoré l'anniversaire de sa fondation.
The mayor celebrated the courage of the firefighters in his speech.
Le maire a salué le courage des pompiers dans son discours.
""",
"""
*celebration* n. B1 
Priests wear a cope during big religious celebrations.
Les prêtres portent une chape pour les grandes célébrations religieuses.
""",
"""
*celebrity* n. A2 
A great number of celebrities use social media.
De nombreuses célébrités utilisent les médias sociaux.
This celebrity is known for her outrageous outfits.
Cette célébrité est connue pour ses tenues scandaleuses.
""",
"""
*cell* n. A2
The prisoner was taken back to his cell.
Le prisonnier a été ramené à sa cellule.
A load cell is a measuring instrument.
Une cellule de charge est un instrument de mesure.
A solar cell can convert sunlight into electricity.
Un capteur solaire peut convertir la lumière du soleil en électricité.
I received a call on my cell.
J'ai reçu un appel sur mon portable.
""",
"""
*cent* n. A1 
At best, the economy will grow by one per cent.
Au mieux, la croissance économique sera de un pour cent.
""",
"""
*center* n. A1, v. B1 
The archer aims at the center of the target.
L'archer vise le centre de la cible.
A photographer is teaching me how to center my pictures.
Un photographe m'apprend comment cadrer mes photos.
""",
"""
*central* adj. B1 
I am renting an apartment near a central avenue.
Je loue un appartement près d'une avenue centrale.
Slovakia is located in Central Europe.
La Slovaquie se situe en Europe centrale.
Friendship is a central theme in the book.
L'amitié est un thème clé du livre.
The company is central to the local economy.
L'entreprise est indispensable pour l'économie locale.
""",
"""
*century* n. A2 
The castle has changed very little over the centuries.
Le château a très peu changé au fil des siècles.
The history of this town spans four centuries.
L'histoire de cette ville couvre quatre siècles.
"""
]

import os
os.system('say "début"' )
os.environ["IMAGEIO_FFMPEG_EXE"] = "/opt/homebrew/bin/ffmpeg"
from transformers import SpeechT5Processor, SpeechT5ForTextToSpeech, SpeechT5HifiGan
from datasets import load_dataset
from gtts import gTTS
import soundfile as sf
import torch
import random
import string
import re
from pydub import AudioSegment
device = "cpu"
import cv2
import numpy as np
import textwrap
from PIL import ImageFont, ImageDraw, Image
from moviepy.editor import VideoFileClip, AudioFileClip, clips_array, CompositeVideoClip, concatenate_videoclips, concatenate_audioclips
from moviepy.config import change_settings

for i in range(len(texte)):
    print("weshhhh")
    texte_entree = texte[i]
    print("texte_entree : ", texte_entree)
    #if len(texte_entree) %2 != 0:
    #    print(texte_entree)
    #    os.system('say "erreur nombre de phrases impair, fin"' )
    #    break
    #-----------------------------------------
    word = "z_dont_know"
    mytext = []
    my_en_text = []
    #-----------------------------------------
    try:
        a = texte_entree.split("\n")
        if a[0] == "" or a[0] == ' ' or a[0] == '\n':
            del a[0]
        if a[-1] == "" or a[-1] == ' ' or a[-1] == '\n':
            del a[-1]
        w = a[0]
        del a[0]

        for i in range(len(a)):
            if "*" in a[i] or ":" in a[i]:
                a[i] = a[i][(a[i].index(":"))+1:].strip()
                a[i] = re.sub(r'^[^\w]+|[^\w]+$', '', a[i]).strip()
    except:
        print("ERROR!!!!!!")
        os.system('say "erreur dans une phrase"' )

    #---------------------------------------------
    frame_rate = 24
    def generate_video2(vduree, vtexte, vnom):
        largeur, hauteur = 1280, 720
        duree = vduree
        nom_video = vnom
        fourcc = cv2.VideoWriter_fourcc(*'mp4v')
        video = cv2.VideoWriter(nom_video, fourcc, frame_rate, (largeur, hauteur))
        texte = vtexte
        pil_font = ImageFont.truetype('/Library/Fonts/Arial.ttf', size=75)
        max_line_length = largeur - 20
        lines = textwrap.wrap(texte, width=30)
        line_height = int(pil_font.getmask(lines[0]).getbbox()[3] + 20)
        total_text_height = len(lines) * line_height
        position_x = (largeur - max_line_length) // 2
        position_y = (hauteur - total_text_height) // 2
        for temps_en_seconde in range(duree * frame_rate):
            image = np.zeros((hauteur, largeur, 3), dtype=np.uint8)
            y = position_y
            img_pil = Image.fromarray(image)
            draw = ImageDraw.Draw(img_pil)
            for line in lines:
                text_mask = pil_font.getmask(line)
                text_size = (text_mask.getbbox()[2] - text_mask.getbbox()[0], text_mask.getbbox()[3] - text_mask.getbbox()[1])
                x = position_x + (max_line_length - text_size[0]) // 2
                draw.text((x, y), line, font=pil_font, fill=(255, 255, 255))
                y += line_height
            image = np.array(img_pil)
            video.write(image)
        video.release()
        cv2.destroyAllWindows()

    #-------------------------------------------------
    mot_extrait = re.search(r'\*(\w+)', w)
    if mot_extrait:
        mot = mot_extrait.group(1)
        print(mot.upper())
        word = mot
        print(word)
    if word=="z_dont_know":
        os.system('say "le mot n\'est pas reconnu"' )

    #---------------------------------------------------
    if len(a) % 2 != 0:
        print("ERRORR !!!!!")
        os.system('say "erreur nombre de phrases impair"' )

    #-----------------------------------------------------
    for i in range(len(a)):
        if i%2==0:
            my_en_text.append(a[i])
        else:
            mytext.append(a[i])

    #--------------------------------------------------------
    nb_text = len(my_en_text)
    #-----------------------------------------------------
    language = 'fr'
    i = 0
    for text in mytext:
        myobj = gTTS(text=text, lang=language, slow=False)
        i += 1
        myobj.save(f"temporaire/fr_audio_{i}.mp3")
        audio = AudioSegment.from_mp3(f"temporaire/fr_audio_{i}.mp3")
        silence = AudioSegment.silent(duration=200)
        audio_with_silence = silence + audio
        audio_accelere = audio_with_silence.speedup(playback_speed=1.1)
        audio_accelere.export(f"temporaire/fr_audio_{i}.mp3", format="mp3")

    #-----------------------------------------------------------------
    processor = SpeechT5Processor.from_pretrained("microsoft/speecht5_tts")
    model = SpeechT5ForTextToSpeech.from_pretrained("microsoft/speecht5_tts").to(device)
    vocoder = SpeechT5HifiGan.from_pretrained("microsoft/speecht5_hifigan").to(device)
    embeddings_dataset = load_dataset("Matthijs/cmu-arctic-xvectors", split="validation")
    #----------------------------------------------------------------------
    speakers = {
        'awb': 0,     # Scottish male
        'bdl': 1138,  # US male
        'clb': 2271,  # US female
        'jmk': 3403,  # Canadian male
        'ksp': 4535,  # Indian male
        'rms': 5667,  # US male
        'slt': 6799   # US female
    }
    #------------------------------------------------------
    def save_text_to_speech(text, nb, speaker=None):
        inputs = processor(text=text, return_tensors="pt").to(device)
        if speaker is not None:
            speaker_embeddings = torch.tensor(embeddings_dataset[speaker]["xvector"]).unsqueeze(0).to(device)
        else:
            speaker_embeddings = torch.randn((1, 512)).to(device)
        speech = model.generate_speech(inputs["input_ids"], speaker_embeddings, vocoder=vocoder)
        if speaker is not None:
            output_filename = f"temporaire/en_audio_{nb}.mp3"
        else:
            random_str = ''.join(random.sample(string.ascii_letters+string.digits, k=5))
            output_filename = f"temporaire/en_audio_{nb}.mp3"
        sf.write(output_filename, speech.cpu().numpy(), samplerate=16000)
        return output_filename

    #------------------------------------------------------------
    for i,text in enumerate(my_en_text):
        voice = random.choice(['slt','bdl'])
        save_text_to_speech(text, i+1, speaker=speakers[voice])

    #-----------------------------------------------------------
    change_settings({"default_duration": 1/24})
    dossier_sortie = f"temporaire/words/{word}"
    base_path = f"temporaire/words/{word}/"
    if not os.path.exists(dossier_sortie):
        os.makedirs(dossier_sortie)

    audio1 = AudioFileClip("temporaire/fr_audio_1.mp3")
    audio2 = AudioFileClip("temporaire/en_audio_1.mp3")
    audio_concatene = concatenate_audioclips([audio1, audio2])
    chemin_sortie = os.path.join(dossier_sortie, f"audio_{word}.mp3")
    audio_concatene.write_audiofile(chemin_sortie)
    audio = AudioSegment.from_file(f"temporaire/words/{word}/audio_{word}.mp3")
    duree_millisecondes = len(audio)
    duree_secondes = round(duree_millisecondes / 1000 + 0.15)
    if nb_text <= 1:
        generate_video2(duree_secondes, my_en_text[0], f"temporaire/words/{word}/video_en_test_final.mp4")
    else:
        generate_video2(duree_secondes, my_en_text[0], f"temporaire/words/{word}/video_en_test_1.mp4")
                                
    if nb_text > 1:
        fichier_concatene = audio_concatene  # Conservez le fichier concaténé précédent
        base_path = f"temporaire/words/{word}/"
        first_video_path = f"temporaire/words/{word}/video_en_test_1.mp4"
        for i in range(nb_text - 1):
            audio1 = AudioFileClip(f"temporaire/fr_audio_{i + 2}.mp3")
            audio2 = AudioFileClip(f"temporaire/en_audio_{i + 2}.mp3")
            fichier_concatene = concatenate_audioclips([fichier_concatene, audio1, audio2])
            chemin_sortie = os.path.join(dossier_sortie, f"audio_{word}.mp3")
            fichier_concatene.write_audiofile(chemin_sortie)
            audio_1 = AudioSegment.from_file(f"temporaire/fr_audio_{i + 2}.mp3")
            audio_2 = AudioSegment.from_file(f"temporaire/en_audio_{i + 2}.mp3")
            duree_millisecondes_ = len(audio_1) + len(audio_2)
            duree_secondes_ = round(duree_millisecondes_ / 1000 + 0.15)
            generate_video2(duree_secondes_, my_en_text[i+1], f"temporaire/words/{word}/video_en_test_{i+2}.mp4")
            clip1 = VideoFileClip(base_path+f"video_en_test_{i+1}.mp4")
            clip2 = VideoFileClip(base_path+f"video_en_test_{i+2}.mp4")
            final_clip = concatenate_videoclips([clip1, clip2])
            if i == nb_text-2:
                final_clip.write_videofile(base_path+f"video_en_test_final.mp4", codec="libx264", fps=frame_rate, audio_codec='aac')
            else:
                final_clip.write_videofile(base_path+f"video_en_test_{i+2}.mp4", codec="libx264", fps=frame_rate, audio_codec='aac')

    video_clip = VideoFileClip(base_path+f"video_en_test_final.mp4")
    audio_clip = AudioFileClip(base_path+f"audio_{word}.mp3")
    #---------------------------------------------------------------------------
    video_clip = video_clip.set_duration(audio_clip.duration)
    video_with_audio = video_clip.set_audio(audio_clip)
    video_with_audio.write_videofile(base_path+f"video_with_audio_{word}.mp4", codec="libx264", fps=frame_rate,  audio_codec='aac')
    #-----------------------------------------------------------------------------
    dossier = base_path # "temporaire/words/affect"
    for fichier in os.listdir(dossier):
        if "with" not in fichier:
            chemin_fichier = os.path.join(dossier, fichier)
            os.remove(chemin_fichier)

    #--------------------------------------------------------------
    for fichier in os.listdir("temporaire/"):
        if fichier.endswith(".mp3"):
            chemin_fichier = os.path.join("temporaire/", fichier)
            os.remove(chemin_fichier)

    #-------------------------------------------------------------
    message = f"fin pour {word}"
    os.system(f'say {message}')